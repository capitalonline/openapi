(window["webpackJsonp_AppSp"]=window["webpackJsonp_AppSp"]||[]).push([["chunk-f430c508"],{"0695":function(t,s,e){},8961:function(t,s,e){"use strict";e.r(s);var a=function(){var t=this,s=t._self._c;t._self._setupProxy;return s("div",[s("div",[s("action-block",{style:{display:"flex","flex-wrap":"nowrap","overflow-x":"auto","min-width":"1000px"},attrs:{search_option:t.search},on:{"fn-search":t.fn_search}})],1),s("div",{staticClass:"prompt_message"},[t._v("重试：支持对失败状态的任务进行重试；忽略：支持对任务进行忽略，忽略的任务不展示")]),s("el-table",{ref:"evenTable",staticClass:"event-table",attrs:{data:t.event_list,border:""},on:{"filter-change":t.filterAttribute,"expand-change":t.rowClick}},[s("el-table-column",{attrs:{type:"expand"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{staticStyle:{overflow:"hidden",padding:"0 0 24px"}},[s("ul",[s("li",[s("h1",[t._v("step1："),s("el-button",{attrs:{type:"primary"},on:{click:function(s){return t.getUnderlyingTasksInfo(e.row.task_id)}}},[t._v("检查底层任务状态")])],1)]),("failed"==t.maintask.status||t.step2_mainTaskStatus)&&t.step1_status&&!t.step2_noFaild&&t.main_list?s("li",[s("h1",[t._v("step2：底层任务修复")]),s("div",{staticClass:"m-top10 m-bottom10"},[s("b",[t._v("主任务：")])]),s("el-table",{staticStyle:{width:"99%"},attrs:{data:t.maintaskList,border:""}},[s("el-table-column",{attrs:{prop:"taskId",width:"260",label:"主任务Id"}}),s("el-table-column",{attrs:{prop:"execEndTime",width:"230",label:"上一次执行结束时间"}}),s("el-table-column",{attrs:{label:"当前错误参数显示",width:t.tableWidth_1},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{on:{click:function(s){return t.waclosed()}}},[s("json-views",{attrs:{data:e.row.globalContext,closed:t.is_closed}}),e.row.globalContext?s("Clipboard",{attrs:{content:JSON.stringify(e.row.globalContext)}}):t._e()],1)]}}],null,!0)})],1),s("div",{staticClass:"m-top10 m-bottom10"},[s("b",[t._v("子任务列表：")])]),t.subtasks_step2.length>0?s("el-table",{staticStyle:{width:"99%"},attrs:{data:t.subtasks_step2,border:""}},[s("el-table-column",{attrs:{width:"55"},scopedSlots:t._u([{key:"default",fn:function(e){return["failed"==e.row.status?s("el-checkbox",{model:{value:e.row.isCheck,callback:function(s){t.$set(e.row,"isCheck",s)},expression:"step.row.isCheck"}}):t._e()]}}],null,!0)}),s("el-table-column",{attrs:{prop:"subtaskId",label:"子任务Id"}}),s("el-table-column",{attrs:{prop:"status",width:"80",label:"状态"}}),s("el-table-column",{attrs:{prop:"errorMsg",label:"失败原因"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{staticClass:"text-container"},[s("div",{ref:"textContent",staticClass:"text-content",class:{expanded:t.isExpanded[e.$index]}},[t.isExpanded[e.$index]?s("div",[t._v(t._s(e.row.errorMsg))]):s("div",[t._v(t._s(t.truncateText(e.row.errorMsg,3)))])]),e.row.errorMsg?s("el-button",{attrs:{type:"text"},on:{click:function(s){return t.toggleExpand(e.$index)}}},[s("div",{staticClass:"button-container"},[s("i",{class:t.isExpanded[e.$index]?"el-icon-arrow-up":"el-icon-arrow-down"})])]):t._e()],1)]}}],null,!0)}),s("el-table-column",{attrs:{prop:"executorName",label:"执行服务"}}),s("el-table-column",{attrs:{prop:"subtaskName",label:"子任务名称"}}),s("el-table-column",{attrs:{prop:"execTime",label:"执行时间"}}),s("el-table-column",{attrs:{label:"回调参数",width:t.tableWidth_2},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{on:{click:function(s){return t.waclosed_2()}}},[Object.keys(e.row.callbackContent).length>0?s("json-views",{attrs:{data:e.row.callbackContent,closed:t.is_closed}}):s("span",[t._v("-")])],1)]}}],null,!0)}),s("el-table-column",{attrs:{label:"当前错误参数显示",width:t.tableWidth_3},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{on:{click:function(s){return t.waclosed_3()}}},[s("json-views",{attrs:{data:e.row.parameters,closed:t.is_closed},on:{click:t.waclosed}})],1),e.row.parameters?s("Clipboard",{attrs:{content:JSON.stringify(e.row.parameters)}}):t._e()]}}],null,!0)})],1):t._e(),s("el-button",{staticClass:"m-top10 m-bottom10",attrs:{type:"primary",disabled:t.step2_repair},on:{click:function(s){return t.setReTasks(e.row.task_id)}}},[t._v("底层任务修复执行")]),t.step2_status&&!t.step2_mainTaskStatus?s("div",{staticStyle:{width:"25%"}},[s("el-progress",{attrs:{percentage:0}}),s("span",{staticClass:"step-result"},[t._v(t._s(t.step2_doing))])],1):t._e(),t.step2_status&&t.step2_mainTaskStatus?s("div",{staticStyle:{width:"25%"}},[s("el-progress",{attrs:{percentage:t.step2_progress}}),100!==t.step2_progress?s("span",{staticClass:"step-result"},[t._v(t._s(t.step2_doing))]):t._e(),s("br"),t._l(t.subtasks,(function(e){return s("span",["doing"==e.status&&100!==t.step2_progress?s("span",[t._v(" "+t._s(e.subtaskCnName))]):t._e()])}))],2):t._e(),100===t.step2_progress&&t.step2_mainTaskStatus?s("div",{staticClass:"step-result"},[t._v("执行结果： "),"failed"==t.maintask.status?s("span",[t._v("任务失败 "),t._l(t.filter_info,(function(e){return s("div",[s("span",[t._v(t._s(e.subtaskCnName))]),s("br"),s("span",[t._v(t._s(e.errorMsg))]),s("br"),s("span",{staticClass:"error"},[t._v("底层任务修复失败，请联系相关研发处理")])])}))],2):s("span",[t._v("任务成功")])]):t._e()],1):t.step2_noFaild?s("span",[s("li",[s("h1",[t._v("step2：底层任务修复")]),s("span",{staticClass:"step-result"},[t._v("底层任务无需修复")])])]):t._e(),t.step1_status&&t.main_list?s("li",[s("h1",[t._v("step3：修复业务层")]),s("el-table",{staticClass:"event-table",staticStyle:{width:"99%"},attrs:{data:t.resources,border:""}},[s("el-table-column",{attrs:{prop:"resource_id",label:"资源id"}}),s("el-table-column",{attrs:{prop:"resource_type",label:"资源类型"}}),s("el-table-column",{attrs:{prop:"need_repair",label:"是否需要修复"},scopedSlots:t._u([{key:"default",fn:function(s){return[t._v(" "+t._s(s.row.need_repair?"是":"否")+" ")]}}],null,!0)}),s("el-table-column",{attrs:{prop:"status_display",label:"初始状态"}}),s("el-table-column",{attrs:{prop:"expect_status_display",label:"期望状态"}}),s("el-table-column",{attrs:{prop:"after_status_display",label:"修复后状态"}})],1),s("el-button",{staticClass:"m-top10 m-bottom10",attrs:{type:"primary",disabled:t.step3_repair},on:{click:function(s){return t.setTasksStatus(e.row.task_id)}}},[t._v("修复业务层执行")]),Object.keys(t.step3_str).length>0?s("div",{staticClass:"step-result"},[t._v("执行结果： "),t._l(t.step3_str,(function(e,a){return s("div",[t._v(" "+t._s(a)+":"+t._s(e)+" "),s("br")])}))],2):t._e()],1):t._e()])])]}}])}),s("el-table-column",{attrs:{prop:"task_id",label:"任务ID"}}),s("el-table-column",{attrs:{prop:"task_type",label:"任务名称"}}),s("el-table-column",{attrs:{prop:"cloud_id",label:"资源ID"}}),s("el-table-column",{attrs:{prop:"customer_id",label:"客户ID"}}),s("el-table-column",{attrs:{prop:"customer_name",label:"客户名称"}}),s("el-table-column",{attrs:{prop:"az_name",label:"可用区"}}),s("el-table-column",{attrs:{prop:"task_state",label:"任务状态"}}),s("el-table-column",{attrs:{prop:"error_type",label:"失败类型","filter-multiple":!1,"column-key":"error_type",filters:t.error_type_list},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",[t._v(t._s(e.row.error_type))])]}}])}),s("el-table-column",{attrs:{prop:"subtask_name",label:"当前执行流程"}}),s("el-table-column",{attrs:{prop:"detail",label:"失败原因"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-tooltip",{attrs:{content:e.row.detail,"popper-class":"tooltip-width",placement:"bottom",effect:"light"}},[s("span",[t._v(t._s(e.row.detail.length>20?e.row.detail.slice(0,21)+"...":e.row.detail))])])]}}])}),s("el-table-column",{attrs:{prop:"create_time",label:"创建时间"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",[t._v(t._s(e.row.create_time?t.moment(e.row.create_time).format("YYYY-MM-DD HH:mm:ss"):"--"))])]}}])}),s("el-table-column",{attrs:{prop:"end_time",label:"完成时间"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",[t._v(t._s(e.row.end_time?t.moment(e.row.end_time).format("YYYY-MM-DD HH:mm:ss"):"--"))])]}}])}),s("el-table-column",{attrs:{label:"操作"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-button",{attrs:{type:"text"},on:{click:function(s){return t.ignore(e.row.task_id,e.row.event_id)}}},[t._v("忽略")])]}}])})],1),s("el-pagination",{attrs:{"current-page":t.current,"page-sizes":[20,50,100],"page-size":t.size,layout:"total, sizes, prev, pager, next, jumper",total:t.total},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange}})],1)},i=[],r=(e("14d9"),e("e9f5"),e("910d"),e("7d54"),e("ab43"),e("9ab4")),l=e("1b40"),n=e("c811"),o=e("1296"),_=e("c1df"),c=e.n(_),p=e("1e42"),u=e("1b37"),d=e.n(u);let h=class extends l["e"]{constructor(){super(...arguments),this.search={cloud_id:{placeholder:"请输入资源ID",width:120},task_id:{placeholder:"请输入任务ID",width:120},customer_id:{placeholder:"请输入客户ID",width:118},time:{type:"datetimerange",placeholder:["开始时间","结束时间"],clearable:!1,width:360,defaultTime:[c()(new Date).format("YYYY-MM-DD 00:00:00"),c()(new Date).format("YYYY-MM-DD HH:mm:ss")]}},this.event_num=0,this.finish_num=0,this.finished_percent="0.00%",this.fail_num=0,this.error_percent="0.00%",this.err="err",this.current=1,this.size=20,this.total=0,this.moment=c.a,this.tableWidth_1="200",this.tableWidth_2="200",this.tableWidth_3="200",this.event_list=[],this.min_date="",this.search_data={},this.event_detail=!1,this.sort_prop_name="",this.sort_value="",this.error_type_list=[],this.filter_obj={},this.step1_status=!1,this.maintask={},this.maintaskList=[],this.subtasks=[],this.subtasks_step2=[],this.resources=[],this.re_parameters="",this.step3_str={},this.step2_str="",this.step2_progress=0,this.step2_status=!1,this.clear=null,this.step2_mainTaskStatus=!1,this.step2_repair=!1,this.step3_repair=!1,this.filter_info=[],this.scrollPosition=0,this.isExpanded=[],this.step2_noFaild=!1,this.main_list=!1,this.is_closed=!0,this.step2_doing=""}created(){this.getFilterList(),this.fn_search()}waclosed(){this.tableWidth_1="200"===this.tableWidth_1?"450":"200"}waclosed_2(){this.tableWidth_2="200"===this.tableWidth_2?"450":"200"}waclosed_3(){this.tableWidth_3="200"===this.tableWidth_3?"450":"200"}async getFilterList(){let t=await o["a"].get_filter_item({filed_names:["error_type"]});if("Success"===t.code)for(let s in t.data.error_type)this.error_type_list.push({text:t.data.error_type[s],value:s})}fn_search(t={}){this.current=1,this.search_data={...t,...this.filter_obj},this.get_error_task_list()}async get_error_task_list(t=!0){t||this.$store.commit("SET_LOADING",!1);const{search_data:s}=this,e=await o["a"].get_repair_event_list({page_index:this.current,page_size:this.size,az_id:s.az_id||"",cloud_id:s.cloud_id||"",task_type:s.task_type||"",task_id:s.task_id||"",customer_id:s.customer_id||"",customer_name:s.customer_name||"",error_type:s.error_type?s.error_type[0]:void 0,start_time:s.time?c()(s.time[0]).format("YYYY-MM-DD HH:mm:ss"):c()(new Date).format("YYYY-MM-DD 00:00:00"),end_time:s.time?c()(s.time[1]).format("YYYY-MM-DD HH:mm:ss"):c()(new Date).format("YYYY-MM-DD HH:mm:ss")});var a,i,r;"Success"===e.code?(this.event_list=(null===(a=e.data)||void 0===a?void 0:a.task_list)||[],this.event_list=this.event_list.map(t=>Object.assign({},t,{isExpand:!1})),this.total=(null===(i=e.data)||void 0===i||null===(r=i.page_info)||void 0===r?void 0:r.count)||0):this.$message.error(e.msg||"操作错误")}handleSizeChange(t){this.size=t,this.get_error_task_list()}toggleExpand(t){this.$set(this.isExpanded,t,!this.isExpanded[t])}truncateText(t,s){if(!t)return"";const e=t.split("\n"),a=e.slice(0,s).join("\n");return a+(e.length>s?"...":"")}calculateLines(t){return t?t.split("\r\n").length:0}handleCurrentChange(t){this.current=t,this.get_error_task_list()}filterAttribute(t){this.filter_obj={...this.filter_obj,...t},this.fn_search(this.search_data)}async retry(t,s){let e=await o["a"].retry_task({task_id:t,event_id:s});"Success"===e.code&&(this.$message.success(e.message),this.get_error_task_list())}async ignore(t){let s=await o["a"].ignore({task_id:t});"Success"===s.code&&(this.$message.success(s.message),this.get_error_task_list())}async getUnderlyingTasksInfo(t,s=!0,e=!1){s||this.$store.commit("SET_LOADING",!1);let a=await o["a"].getUnderlyingTasks({task_id:t});if(this.step1_status=!0,"Success"===a.code)if(void 0!==a.data.maintask_record&&null!==a.data.maintask_record&&0===Object.keys(a.data.maintask_record).length)this.main_list=!1,this.$message.error("主任务不存在");else if(this.main_list=!0,this.maintask=a.data.maintask,this.maintaskList=[a.data.maintask],this.subtasks=a.data.subtasks,this.step2_progress=a.data.process,this.step2_mainTaskStatus=e,this.subtasks_step2=a.data.subtasks.map(t=>Object.assign({},t,{re_parameters:"",isCheck:"failed"===t.status})),!this.step2_mainTaskStatus&&this.subtasks_step2.length>0){this.step2_noFaild=!0,this.step2_repair=!0,this.step3_repair=!1;let t=!1,s=!1;for(let e of this.subtasks_step2)"doing"!==e.status&&"waiting"!==e.status||(t=!0),"failed"!==this.maintask.status&&"failed"!==e.status||(s=!0);s&&(this.step2_noFaild=!1,this.step3_repair=!0,this.step2_repair=!1),t&&(this.step2_noFaild=!1,this.step3_repair=!0,this.step2_repair=!0)}else{this.step3_repair=!0,this.step2_repair=!0,this.step2_noFaild=!1;let t=!1,s=!1;for(let e of this.subtasks_step2)"doing"!==e.status&&"waiting"!==e.status&&"retry_init"!==e.status||(t=!0),"failed"!==this.maintask.status&&"failed"!==e.status||(s=!0);s&&(this.step3_repair=!0,this.step2_repair=!1),(t||100!==this.step2_progress)&&(this.step3_repair=!0,this.step2_repair=!0),s||t||(this.step3_repair=!1,this.step2_repair=!0)}this.getResourceStatusInfo(t,s),"doing"!==this.maintask.status&&this.clear&&this.FnClearTimer(),this.step2_mainTaskStatus&&"failed"==this.maintask.status?this.filter_info=a.data.fail_subtasks.map(t=>({subtaskName:t.subtaskName,errorMsg:t.errorMsg})):this.step2_mainTaskStatus&&"success"==this.maintask.status&&(this.step3_repair=!1)}async getResourceStatusInfo(t,s=!0){if(s||this.$store.commit("SET_LOADING",!1),s){let s=await o["a"].getResourceStatus(),e=await o["a"].getTasksStatus({task_id:t});"Success"===s.code&&"Success"===e.code&&(e.data.resource_detail?this.resources=Object.keys(e.data.resource_detail).map(t=>{const a=e.data.resource_detail[t],i=s.data[a.resource_type];return Object.assign({},a,{re_status:i[0].status,re_status_list:i})}):this.step3_repair=!0)}else await Promise.all([o["a"].getResourceStatus(),o["a"].getTasksStatus({task_id:t})]).then(([t,s])=>{"Success"===t.code&&"Success"===s.code&&(s.data.resource_detail?this.resources=Object.keys(s.data.resource_detail).map(e=>{const a=s.data.resource_detail[e],i=t.data[a.resource_type];return Object.assign({},a,{re_status:i[0].status,re_status_list:i})}):(this.step3_repair=!0,"success"===this.maintask.status&&this.step3_repair&&(this.$message.success("任务修复成功"),this.get_error_task_list(!1))))})}async setTasksStatus(t){let s=this.resources.filter(t=>t.need_repair).map(t=>({resource_id:t.resource_id,resource_type:t.resource_type,expect_status:t.re_status})),e=await o["a"].setTasksStatus({task_id:t,repair_resource:s});if("Success"===e.code){const s=e.data.repair_list;this.resources=this.resources.map(t=>Object.assign({},t,{after_status:s[t.resource_id].status,after_status_display:s[t.resource_id].status_display})),this.step3_str=e.data.repair_detail,this.getResourceStatusInfo(t,!1);let a=!1;this.resources.forEach(t=>{!0===t.need_repair&&(a=!0)}),this.step3_repair=!a,this.step3_repair&&(this.get_error_task_list(!1),this.$message.success("任务修复成功"))}}async setReTasks(t){this.step2_doing="任务正在修复，请耐心等待：",this.step2_repair=!0,this.step2_status=!0,this.$store.commit("SET_LOADING",!1);let s=this.subtasks_step2.filter(t=>"failed"===t.status).map(t=>({failedSubExecFlag:t.isCheck?1:0,subtaskId:t.subtaskId,parameters:t.re_parameters})),e=await o["a"].setReTasks({task_id:t,global_context:""!==this.re_parameters?this.re_parameters:void 0,subtasks:s});"Success"===e.code?(this.step2_str=e.message,this.FnSetTimer(t)):this.step2_repair=!1}FnSetTimer(t){this.clear&&this.FnClearTimer(),this.clear=setInterval(()=>{this.step2_str="",this.getUnderlyingTasksInfo(t,!1,!0)},5e3)}FnClearTimer(){this.clear&&clearInterval(this.clear)}rowClick(t){this.event_list.forEach(s=>{t.task_id!==s.task_id?(this.$refs["evenTable"].toggleRowExpansion(s,!1),s.isExpand=!1):(t.isExpand?s.isExpand=!1:s.isExpand=!0,this.$refs["evenTable"].toggleRowExpansion(s,s.isExpand))}),this.clearTask()}clearTask(){this.step1_status=!1,this.step2_noFaild=!1,this.maintask={},this.maintaskList=[],this.subtasks=[],this.subtasks_step2=[],this.resources=[],this.re_parameters="",this.step3_str={},this.step2_str="",this.step2_status=!1,this.main_list=!1,this.filter_info=[],this.step2_doing=""}};h=Object(r["a"])([Object(l["a"])({components:{ActionBlock:n["a"],Clipboard:p["a"],JsonViews:d.a}})],h);var m=h,b=m,f=(e("e613"),e("2877")),k=Object(f["a"])(b,a,i,!1,null,null,null);s["default"]=k.exports},e613:function(t,s,e){"use strict";e("0695")}}]);
//# sourceMappingURL=chunk-f430c508.1764156034953.js.map